// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Better Auth tables
model User {
  id                String             @id @default(cuid())
  name              String?
  email             String             @unique
  emailVerified     DateTime?
  image             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  role              UserRole           @default(CUSTOMER)
  
  // Better Auth relations
  sessions          Session[]
  accounts          Account[]
  
  // Organization relations
  members           Member[]
  
  @@map("user")
}

model Session {
  id                String   @id @default(cuid())
  sessionToken      String   @unique @map("session_token")
  userId            String   @map("user_id")
  expires           DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Organization context
  activeOrganizationId String? @map("active_organization_id")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("session")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("account")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtoken")
}

// Better Auth Organization plugin tables
model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  members     Member[]
  sites       Site[]
  
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  role           MemberRole   @default(MEMBER)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([organizationId, userId])
  @@map("member")
}

// Application-specific tables
model Site {
  id               String       @id @default(cuid())
  name             String
  domain           String
  url              String
  organizationId   String       @map("organization_id")
  
  // GSC Connection
  gscPropertyUrl   String?      @map("gsc_property_url")
  gscRefreshToken  String?      @map("gsc_refresh_token") // Encrypted
  gscConnectedAt   DateTime?    @map("gsc_connected_at")
  
  // Settings
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  // Relations
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  searchConsoleData SearchConsoleData[]
  performanceTests PerformanceTest[]
  seoScores        SeoScore[]
  crawlResults     CrawlResult[]
  
  @@unique([organizationId, domain])
  @@map("site")
}

model SearchConsoleData {
  id          String   @id @default(cuid())
  siteId      String   @map("site_id")
  date        DateTime
  
  // Dimensions
  query       String?
  page        String?
  country     String?
  device      String?
  
  // Metrics
  clicks      Int      @default(0)
  impressions Int      @default(0)
  ctr         Float    @default(0)
  position    Float    @default(0)
  
  createdAt   DateTime @default(now())
  
  site        Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  
  @@unique([siteId, date, query, page, country, device])
  @@index([siteId, date])
  @@index([siteId, query])
  @@index([siteId, page])
  @@map("search_console_data")
}

model PerformanceTest {
  id                String     @id @default(cuid())
  siteId            String     @map("site_id")
  testUrl           String     @map("test_url")
  device            DeviceType
  
  // Overall Score
  score             Int?       // 0-100
  
  // Core Web Vitals
  lcp               Float?     // Largest Contentful Paint (seconds)
  inp               Float?     // Interaction to Next Paint (ms)
  cls               Float?     // Cumulative Layout Shift
  ttfb              Float?     // Time to First Byte (ms)
  fcp               Float?     // First Contentful Paint (seconds)
  speedIndex        Float?     // Speed Index (seconds)
  
  // Status
  status            TestStatus @default(PENDING)
  errorMessage      String?    @map("error_message")
  
  // Metadata
  lighthouseVersion String?    @map("lighthouse_version")
  testDuration      Int?       @map("test_duration") // milliseconds
  
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  
  site              Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  
  @@index([siteId, createdAt])
  @@index([siteId, device])
  @@map("performance_test")
}

model SeoScore {
  id                String   @id @default(cuid())
  siteId            String   @map("site_id")
  date              DateTime
  
  // Overall Score
  score             Int      // 0-100
  
  // Component Scores
  clickTrend        Int      @map("click_trend")        // 0-100
  positionTrend     Int      @map("position_trend")     // 0-100
  impressionTrend   Int      @map("impression_trend")   // 0-100
  ctrBenchmark      Int      @map("ctr_benchmark")      // 0-100
  performanceScore  Int?     @map("performance_score")  // 0-100 (from PageSpeed)
  
  // Metadata
  breakdown         Json?    // Detailed scoring breakdown
  createdAt         DateTime @default(now())
  
  site              Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  
  @@unique([siteId, date])
  @@index([siteId, date])
  @@map("seo_score")
}

model CrawlResult {
  id                     String       @id @default(cuid())
  siteId                 String       @map("site_id")
  crawlDate              DateTime     @map("crawl_date")
  url                    String
  
  // Response Info
  statusCode             Int          @map("status_code")
  loadTimeMs             Int          @map("load_time_ms")
  
  // SEO Content
  title                  String?
  metaDescription        String?      @map("meta_description") @db.Text
  h1Count                Int          @map("h1_count") @default(0)
  h2Count                Int          @map("h2_count") @default(0)
  
  // Images
  totalImages            Int          @map("total_images") @default(0)
  imagesWithoutAlt       Int          @map("images_without_alt") @default(0)
  
  // Content Metrics
  wordCount              Int          @map("word_count") @default(0)
  contentLength          Int          @map("content_length") @default(0)
  
  // Links
  totalLinks             Int          @map("total_links") @default(0)
  internalLinks          Int          @map("internal_links") @default(0)
  externalLinks          Int          @map("external_links") @default(0)
  brokenLinks            Int          @map("broken_links") @default(0)
  
  // Issues & Analysis
  issues                 Json?        // Array of SEOIssue objects
  
  createdAt              DateTime     @default(now())
  
  site                   Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)
  
  @@index([siteId, crawlDate])
  @@index([siteId, url])
  @@map("crawl_result")
}

// Enums
enum UserRole {
  ADMIN
  CUSTOMER
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum DeviceType {
  MOBILE
  DESKTOP
}

enum TestStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}